{% extends "base.html" %}

{% block title %}‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà - Google Maps Scraper{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center space-x-2">
            <span class="material-icons text-google-blue text-4xl">search</span>
            <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</span>
        </h1>
        <p class="text-gray-600">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å Google Maps</p>
    </div>

    <!-- Search Form -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <form id="search-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Search Query -->
                <div>
                    <label for="search-query" class="block text-sm font-medium text-gray-700 mb-2">
                        ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input
                            type="text"
                            id="search-query"
                            name="query"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°, ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏ß‡∏±‡∏î"
                            class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-google-blue focus:border-transparent"
                            required
                        >
                        <div id="query-suggestions" class="absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
                        </div>
                    </div>
                </div>

                <!-- Province Selection -->
                <div>
                    <label for="province-select" class="block text-sm font-medium text-gray-700 mb-2">
                        ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
                    </label>
                    <select
                        id="province-select"
                        name="province"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-google-blue focus:border-transparent"
                    >
                        <option value="">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô</p>
                </div>
            </div>

            <!-- Search Options -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Max Results -->
                <div>
                    <label for="max-results" class="block text-sm font-medium text-gray-700 mb-2">
                        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
                    </label>
                    <input
                        type="number"
                        id="max-results"
                        name="max_results"
                        value="10"
                        min="1"
                        max="50"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-google-blue"
                    >
                </div>

                <!-- Language -->
                <div>
                    <label for="language-region" class="block text-sm font-medium text-gray-700 mb-2">
                        ‡∏†‡∏≤‡∏©‡∏≤
                    </label>
                    <select
                        id="language-region"
                        name="language_region"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-google-blue"
                    >
                        <option value="th-th">Thai (Thai Locale)</option>
                        <option value="en-th">English (Thai Locale)</option>
                    </select>
                </div>

                <!-- Quick Actions -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
                    </label>
                    <div id="popular-searches" class="flex flex-wrap gap-2">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Enhanced Search Info -->
            <div id="search-enhancement-info" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-start space-x-2">
                    <span class="material-icons text-blue-600 text-sm">info</span>
                    <div class="text-sm text-blue-800">
                        <p class="font-semibold">‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: <span id="enhanced-province-name"></span></p>
                        <p class="text-xs mt-1">‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏õ‡πá‡∏ô "<span id="enhanced-query-example"></span>"</p>
                    </div>
                </div>
            </div>

            <!-- Search Button -->
            <div class="flex justify-end space-x-3">
                <button
                    type="button"
                    onclick="clearSearch()"
                    class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-2"
                >
                    <span class="material-icons text-xl">clear</span>
                    <span>‡∏•‡πâ‡∏≤‡∏á</span>
                </button>
                <button
                    type="submit"
                    id="search-btn"
                    class="px-6 py-2 bg-google-blue hover:bg-blue-600 text-white rounded-lg flex items-center space-x-2"
                >
                    <span class="material-icons text-xl">search</span>
                    <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Search Results -->
    <div id="search-results" class="hidden">
        <!-- Results Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4 flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h2>
                <p class="text-sm text-gray-600">‡∏û‡∏ö <span id="results-count" class="font-semibold">0</span> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</p>
            </div>

            <div class="flex items-center space-x-2">
                <button
                    onclick="selectAll()"
                    class="px-4 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
                >
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button
                    onclick="unselectAll()"
                    class="px-4 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
                >
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>

        <!-- Selected Summary & Actions -->
        <div id="selected-summary" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h3>
                    <p class="text-sm text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß <span id="selected-count" class="font-semibold text-google-blue">0</span> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</p>
                </div>
                <button
                    onclick="proceedToScrape()"
                    class="px-6 py-3 bg-google-blue hover:bg-blue-600 text-white rounded-lg flex items-center space-x-2 shadow-md transform hover:scale-105"
                >
                    <span class="material-icons">play_arrow</span>
                    <span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </button>
            </div>

            <!-- Selected Places Preview -->
            <div id="selected-places-preview" class="bg-gray-50 rounded-lg p-4 max-h-48 overflow-y-auto">
                <!-- Selected places will be shown here -->
            </div>
        </div>

        <!-- Results List -->
        <div id="results-list" class="space-y-3 mb-6">
            <!-- Results will be inserted here -->
        </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
        <span class="material-icons text-gray-400 mb-4" style="font-size: 64px;">search</span>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</h3>
        <p class="text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
    </div>
</div>

<!-- Scrape Settings Modal -->
<div id="scrape-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 flex items-center justify-between">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                <p class="text-sm text-gray-600 mt-1">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            </div>
            <button onclick="closeSettingsModal()" class="text-gray-500 hover:text-gray-700">
                <span class="material-icons">close</span>
            </button>
        </div>

        <form id="scrape-settings-form" class="p-6 space-y-6">
            <!-- Basic Settings Section -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <span class="material-icons text-google-blue mr-2">settings</span>
                    ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                </h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <!-- Max Reviews -->
                    <div>
                        <label for="max-reviews" class="block text-sm font-medium text-gray-700 mb-2">
                            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ï‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
                        </label>
                        <div class="flex items-center space-x-4">
                            <input
                                type="number"
                                id="max-reviews"
                                name="max_reviews"
                                value="100"
                                min="10"
                                max="10000"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-google-blue"
                            >
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="unlimited-reviews" class="w-4 h-4 text-google-blue">
                                <span class="text-sm text-gray-700">‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î</span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: 100-500 ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>
                    </div>

                    <!-- Date Range -->
                    <div>
                        <label for="date-range" class="block text-sm font-medium text-gray-700 mb-2">
                            ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
                        </label>
                        <select
                            id="date-range"
                            name="date_range"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-google-blue"
                        >
                            <option value="1month">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</option>
                            <option value="6months">6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</option>
                            <option value="1year" selected>1 ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</option>
                            <option value="5years">5 ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</option>
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Language Settings Section -->
            <div class="bg-blue-50 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <span class="material-icons text-blue-600 mr-2">language</span>
                    ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏©‡∏≤
                </h3>
                <div>
                    <label for="modal-language-region" class="block text-sm font-medium text-gray-700 mb-2">
                        ‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ
                    </label>
                    <select
                        id="modal-language-region"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 max-w-md"
                    >
                        <option value="th-th">Thai (Thai Locale)</option>
                        <option value="en-th">English (Thai Locale)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ)</p>
                </div>
            </div>

            <!-- Translation Settings Section -->
            <div class="bg-green-50 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <span class="material-icons text-green-600 mr-2">translate</span>
                    ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤
                </h3>

                <!-- Translation Toggle -->
                <div class="mb-4">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="modal-translation-enabled" class="w-5 h-5 text-green-600 rounded focus:ring-green-500">
                        <div>
                            <p class="text-sm font-medium text-gray-700">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤</p>
                            <p class="text-xs text-gray-500">‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ)</p>
                        </div>
                    </label>
                </div>

                <!-- Translation Options (shown when enabled) -->
                <div id="modal-translation-options" class="hidden space-y-4 pl-7 border-l-2 border-green-200">
                    <!-- Target Language -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•
                        </label>
                        <select id="modal-target-language" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-600">
                            <option value="th">‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
                            <option value="en">English (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ñ‡∏π‡∏Å‡πÅ‡∏õ‡∏•‡πÄ‡∏õ‡πá‡∏ô</p>
                    </div>

                    <!-- Translation Content -->
                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-3">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•:</p>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="modal-translate-review-text" class="w-4 h-4 text-green-600 rounded" checked>
                                <div>
                                    <p class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>
                                    <p class="text-xs text-gray-500">‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                </div>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="modal-translate-owner-response" class="w-4 h-4 text-green-600 rounded">
                                <div>
                                    <p class="text-sm text-gray-700">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</p>
                                    <p class="text-xs text-gray-500">‡πÅ‡∏õ‡∏•‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Batch Size -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏• (Batch Size)
                        </label>
                        <select id="modal-batch-size" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-600">
                            <option value="10">10 ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß/‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)</option>
                            <option value="25">25 ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß/‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏£‡πá‡∏ß)</option>
                            <option value="50" selected>50 ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß/‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏õ‡∏Å‡∏ï‡∏¥)</option>
                            <option value="100">100 ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß/‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏Ñ‡∏á‡∏ó‡∏ô)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏à‡∏∞‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏°‡∏≤‡∏Å</p>
                    </div>

                    <!-- Enhanced Detection -->
                    <div>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="modal-enhanced-detection" class="w-4 h-4 text-green-600 rounded">
                            <div>
                                <p class="text-sm font-medium text-gray-700">‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</p>
                                <p class="text-xs text-gray-500">‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 10+ ‡∏†‡∏≤‡∏©‡∏≤)</p>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="mt-3 text-sm text-green-700">
                    <span class="material-icons text-sm align-middle">info</span>
                    ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å Settings ‚Üí Translation Settings ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ
                </div>
            </div>

            <!-- Summary Section -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-3 flex items-center">
                    <span class="material-icons text-yellow-600 mr-2">summarize</span>
                    ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</span>
                        <span id="summary-places-count" class="font-semibold text-gray-900">0 ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤:</span>
                        <span id="summary-translation-status" class="font-semibold text-gray-900">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</span>
                        <span id="summary-target-language" class="font-semibold text-gray-900">-</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button
                    type="button"
                    onclick="closeSettingsModal()"
                    class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
                >
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button
                    type="submit"
                    class="px-6 py-2 bg-google-blue hover:bg-blue-600 text-white rounded-lg flex items-center space-x-2"
                >
                    <span class="material-icons text-xl">play_arrow</span>
                    <span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let searchResults = [];
    let selectedPlaces = [];

    // Apply settings when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Language settings are now handled in the modal, no need to apply to search form
    });

    // Handle search form submit
    document.getElementById('search-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const selectedProvince = formData.get('province');
        const selectedLanguage = formData.get('language') || 'th';

        // Build enhanced query if province is selected
        let query = formData.get('query');
        if (selectedProvince && query) {
            query = `${query} ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î${selectedProvince}`;
        }

        const data = {
            query: query,
            language: selectedLanguage,
            region: selectedLanguage === 'th' ? 'th' : 'us',
            max_results: parseInt(formData.get('max_results'))
        };

        // Show loading
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...');
        document.getElementById('empty-state').classList.add('hidden');

        try {
            const response = await fetch('/api/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                searchResults = result.places;
                displaySearchResults(result.places);
                showAlert(`‡∏û‡∏ö ${result.places.length} ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà`, 'success');
            } else {
                showAlert(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        } catch (error) {
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'error');
            console.error(error);
        } finally {
            hideLoading();
        }
    });

    // Display search results
    function displaySearchResults(places) {
        const resultsList = document.getElementById('results-list');
        const resultsSection = document.getElementById('search-results');
        const resultsCount = document.getElementById('results-count');

        resultsCount.textContent = places.length;
        resultsList.innerHTML = '';

        places.forEach((place, index) => {
            const placeCard = createPlaceCard(place, index);
            resultsList.appendChild(placeCard);
        });

        resultsSection.classList.remove('hidden');
    }

    // Create place card
    function createPlaceCard(place, index) {
        const div = document.createElement('div');
        div.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
        div.innerHTML = `
            <div class="flex items-start space-x-4">
                <input
                    type="checkbox"
                    id="place-${index}"
                    data-index="${index}"
                    onchange="updateSelection()"
                    class="mt-1 w-5 h-5 text-google-blue rounded focus:ring-google-blue"
                >
                <div class="flex-1 min-w-0">
                    <label for="place-${index}" class="cursor-pointer block">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">${place.name}</h3>
                        <p class="text-sm text-gray-600 mb-2">${place.address || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'}</p>
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            ${place.rating ? `
                                <span class="flex items-center space-x-1">
                                    <span class="material-icons text-yellow-500 text-sm">star</span>
                                    <span>${place.rating.toFixed(1)}</span>
                                </span>
                            ` : ''}
                            ${place.total_reviews ? `
                                <span class="flex items-center space-x-1">
                                    <span class="material-icons text-gray-400 text-sm">rate_review</span>
                                    <span>${place.total_reviews.toLocaleString()} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</span>
                                </span>
                            ` : ''}
                            ${place.category ? `
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">${place.category}</span>
                            ` : ''}
                        </div>
                    </label>
                </div>
            </div>
        `;
        return div;
    }

    // Select all
    function selectAll() {
        document.querySelectorAll('input[type="checkbox"][id^="place-"]').forEach(cb => {
            cb.checked = true;
        });
        updateSelection();
    }

    // Unselect all
    function unselectAll() {
        document.querySelectorAll('input[type="checkbox"][id^="place-"]').forEach(cb => {
            cb.checked = false;
        });
        updateSelection();
    }

    // Update selection
    function updateSelection() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="place-"]:checked');
        selectedPlaces = Array.from(checkboxes).map(cb => {
            const index = parseInt(cb.dataset.index);
            return searchResults[index];
        });

        const summary = document.getElementById('selected-summary');
        const count = document.getElementById('selected-count');
        const preview = document.getElementById('selected-places-preview');

        count.textContent = selectedPlaces.length;

        if (selectedPlaces.length > 0) {
            summary.classList.remove('hidden');

            // Show preview
            preview.innerHTML = selectedPlaces.map(p => `
                <div class="text-sm text-gray-700 py-1">
                    <span class="material-icons text-xs text-google-blue align-middle">check_circle</span>
                    ${p.name}
                </div>
            `).join('');
        } else {
            summary.classList.add('hidden');
        }
    }

    // Load settings from both .env (via API) and localStorage (same as Settings page)
    async function loadAllSettings() {
        try {
            // Load settings from .env file via API
            const response = await fetch('/api/settings');
            const envSettings = {};

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.settings) {
                    // Map API response to our setting names
                    Object.assign(envSettings, data.settings);
                    console.log('üåç Loaded from .env API in search page:', envSettings);
                }
            }

            // Load settings from localStorage
            const saved = localStorage.getItem('scraper_settings');
            let localSettings = {};
            if (saved) {
                try {
                    localSettings = JSON.parse(saved);
                    console.log('üì¶ Loaded from localStorage in search page:', localSettings);
                } catch (e) {
                    console.error('‚ùå Failed to parse localStorage in search page:', e);
                }
            }

            // Default settings (fallback)
            const defaultSettings = {
                max_search_results: 10,
                language_region: 'en-th',
                max_reviews: 100,
                unlimited_reviews: false,
                date_range: '1year',
                start_date: null,
                end_date: null,
                auto_save: true,
                show_notifications: true,
                auto_refresh: true,
                default_export: 'csv',
                enable_translation: false,
                target_language: 'th',
                translate_review_text: true,
                translate_owner_response: false,
                translation_batch_size: 50,
                use_enhanced_detection: true
            };

            // Merge: local settings as base, env settings as override (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ .env ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
            const finalSettings = { ...localSettings, ...envSettings };
            console.log('üîÄ Final merged settings in search page (with .env priority):', finalSettings);

            return finalSettings;
        } catch (error) {
            console.error('‚ùå Failed to load settings from API, using localStorage only:', error);

            // Fallback to localStorage only
            const saved = localStorage.getItem('scraper_settings');
            const defaultSettings = {
                max_search_results: 10,
                language_region: 'en-th',
                max_reviews: 100,
                unlimited_reviews: false,
                date_range: '1year',
                start_date: null,
                end_date: null,
                auto_save: true,
                show_notifications: true,
                auto_refresh: true,
                default_export: 'csv',
                enable_translation: false,
                target_language: 'th',
                translate_review_text: true,
                translate_owner_response: false,
                translation_batch_size: 50,
                use_enhanced_detection: true
            };

            return saved ? { ...defaultSettings, ...JSON.parse(saved) } : { ...defaultSettings };
        }
    }

    // Update modal display with all settings
    async function updateModalWithSettings() {
        const settings = await loadAllSettings();

        // Update language settings in modal
        document.getElementById('modal-language-region').value = settings.language_region || 'en-th';

        // Update basic scraping settings (max reviews and date range)
        const maxReviewsInput = document.getElementById('max-reviews');
        const unlimitedCheckbox = document.getElementById('unlimited-reviews');
        const dateRangeSelect = document.getElementById('date-range');

        // Set max reviews
        if (settings.unlimited_reviews) {
            maxReviewsInput.value = 10000;
            maxReviewsInput.disabled = true;
            unlimitedCheckbox.checked = true;
        } else {
            maxReviewsInput.value = settings.max_reviews || 100;
            maxReviewsInput.disabled = false;
            unlimitedCheckbox.checked = false;
        }

        // Set date range
        dateRangeSelect.value = settings.date_range || '1year';

        // Update translation settings (using Settings page field names)
        const translationEnabled = document.getElementById('modal-translation-enabled');
        const translationOptions = document.getElementById('modal-translation-options');

        translationEnabled.checked = settings.enable_translation || false;

        if (settings.enable_translation) {
            translationOptions.classList.remove('hidden');

            // Update translation form values (using Settings page field names)
            document.getElementById('modal-target-language').value = settings.target_language || 'th';
            document.getElementById('modal-batch-size').value = settings.translation_batch_size || 50;
            document.getElementById('modal-translate-review-text').checked = settings.translate_review_text !== false;
            document.getElementById('modal-translate-owner-response').checked = settings.translate_owner_response || false;
            document.getElementById('modal-enhanced-detection').checked = settings.use_enhanced_detection || false;
        } else {
            translationOptions.classList.add('hidden');
        }

        // Update summary section
        updateSummarySection();
    }

    // Update summary section
    function updateSummarySection() {
        // Places count
        document.getElementById('summary-places-count').textContent = `${selectedPlaces.length} ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà`;

        // Translation status from modal form elements
        const translationStatus = document.getElementById('summary-translation-status');
        const targetLanguageDisplay = document.getElementById('summary-target-language');

        if (document.getElementById('modal-translation-enabled').checked) {
            translationStatus.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            translationStatus.className = 'font-semibold text-green-600';

            const targetLanguage = document.getElementById('modal-target-language').value;
            const targetLanguageMap = {
                'th': '‡πÑ‡∏ó‡∏¢',
                'en': 'English'
            };
            targetLanguageDisplay.textContent = targetLanguageMap[targetLanguage] || '‡πÑ‡∏ó‡∏¢';
        } else {
            translationStatus.textContent = '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            translationStatus.className = 'font-semibold text-gray-500';
            targetLanguageDisplay.textContent = '-';
        }
    }

    // Proceed to scrape - show settings modal
    async function proceedToScrape() {
        if (selectedPlaces.length === 0) {
            showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏´‡πà‡∏á', 'warning');
            return;
        }

        // Load and display all settings
        await updateModalWithSettings();

        // Show modal
        document.getElementById('scrape-settings-modal').classList.remove('hidden');
    }

    // Close settings modal
    function closeSettingsModal() {
        document.getElementById('scrape-settings-modal').classList.add('hidden');
    }

    // Handle unlimited reviews checkbox
    document.getElementById('unlimited-reviews').addEventListener('change', function(e) {
        const maxReviewsInput = document.getElementById('max-reviews');
        if (e.target.checked) {
            maxReviewsInput.value = 10000;
            maxReviewsInput.disabled = true;
        } else {
            maxReviewsInput.value = 100;
            maxReviewsInput.disabled = false;
        }
    });

    // Handle translation enabled toggle in modal
    document.getElementById('modal-translation-enabled').addEventListener('change', function(e) {
        const translationOptions = document.getElementById('modal-translation-options');
        if (e.target.checked) {
            translationOptions.classList.remove('hidden');
        } else {
            translationOptions.classList.add('hidden');
        }
        updateSummarySection();
    });

    // Update summary when translation settings change
    ['modal-target-language', 'modal-translate-review-text', 'modal-translate-owner-response'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', updateSummarySection);
        }
    });

    // Handle scrape settings form submit
    document.getElementById('scrape-settings-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(e.target);

        // Build comprehensive settings object using Settings page field names
        const settings = {
            // Basic scraping settings
            max_reviews: document.getElementById('unlimited-reviews').checked ? null : parseInt(formData.get('max_reviews')),
            date_range: formData.get('date_range'),

            // Language settings from modal (same field names as Settings page)
            language_region: document.getElementById('modal-language-region').value,

            // Translation settings from modal (same field names as Settings page)
            enable_translation: document.getElementById('modal-translation-enabled').checked,
            target_language: document.getElementById('modal-target-language').value,
            translation_batch_size: parseInt(document.getElementById('modal-batch-size').value),
            translate_review_text: document.getElementById('modal-translate-review-text').checked,
            translate_owner_response: document.getElementById('modal-translate-owner-response').checked,
            use_enhanced_detection: document.getElementById('modal-enhanced-detection').checked
        };

        const data = {
            places: selectedPlaces,
            settings: settings
        };

        closeSettingsModal();
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

        try {
            const response = await fetch('/api/scrape', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showAlert('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');

                // Redirect to tasks page after 1 second
                setTimeout(() => {
                    window.location.href = '/tasks';
                }, 1000);
            } else {
                showAlert(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        } catch (error) {
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô', 'error');
            console.error(error);
        } finally {
            hideLoading();
        }
    });

    // Thai Provinces functionality
    let provinces = [];
    let popularSearches = [];

    // Load provinces on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadProvinces();
        loadPopularSearches();
        setupEventListeners();
    });

    // Load provinces from API
    async function loadProvinces() {
        try {
            const response = await fetch('/api/thai-provinces');
            const result = await response.json();

            if (result.success) {
                provinces = result.provinces;
                populateProvinceSelect();
            }
        } catch (error) {
            console.error('Failed to load provinces:', error);
        }
    }

    // Load popular searches from API
    async function loadPopularSearches() {
        try {
            const response = await fetch('/api/thai-provinces/popular-searches?limit=10');
            const result = await response.json();

            if (result.success) {
                popularSearches = result.popular_searches;
                displayPopularSearches();
            }
        } catch (error) {
            console.error('Failed to load popular searches:', error);
        }
    }

    // Populate province select dropdown
    function populateProvinceSelect() {
        const select = document.getElementById('province-select');

        // Clear existing options except the first one
        while (select.options.length > 1) {
            select.remove(1);
        }

        // Add provinces
        Object.keys(provinces).forEach(province => {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            select.appendChild(option);
        });
    }

    // Display popular searches
    function displayPopularSearches() {
        const container = document.getElementById('popular-searches');
        container.innerHTML = '';

        popularSearches.forEach(search => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700';
            button.textContent = search.term;
            button.onclick = () => selectPopularSearch(search);
            container.appendChild(button);
        });
    }

    // Select popular search
    function selectPopularSearch(search) {
        document.getElementById('search-query').value = search.term;

        if (search.province) {
            document.getElementById('province-select').value = search.province;
        }

        updateSearchEnhancement();
    }

    // Setup event listeners
    function setupEventListeners() {
        // Province select change
        document.getElementById('province-select').addEventListener('change', updateSearchEnhancement);

        // Query input change
        document.getElementById('search-query').addEventListener('input', handleQueryInput);

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            const suggestions = document.getElementById('query-suggestions');
            if (!document.getElementById('search-query').contains(e.target)) {
                suggestions.classList.add('hidden');
            }
        });
    }

    // Handle query input with suggestions
    async function handleQueryInput(e) {
        const query = e.target.value;
        const suggestionsDiv = document.getElementById('query-suggestions');

        if (query.length < 2) {
            suggestionsDiv.classList.add('hidden');
            return;
        }

        try {
            const response = await fetch(`/api/thai-provinces/suggestions?q=${encodeURIComponent(query)}`);
            const result = await response.json();

            if (result.success && result.suggestions.length > 0) {
                displaySuggestions(result.suggestions);
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        } catch (error) {
            console.error('Failed to get suggestions:', error);
            suggestionsDiv.classList.add('hidden');
        }
    }

    // Display suggestions
    function displaySuggestions(suggestions) {
        const suggestionsDiv = document.getElementById('query-suggestions');
        suggestionsDiv.innerHTML = '';

        suggestions.forEach(suggestion => {
            const suggestionItem = document.createElement('div');
            suggestionItem.className = 'px-4 py-2 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0';

            suggestionItem.innerHTML = `
                <div class="font-medium">${suggestion.province}</div>
                <div class="text-xs text-gray-500">‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô: ${suggestion.keywords.join(', ')}</div>
            `;

            suggestionItem.onclick = () => {
                document.getElementById('search-query').value = suggestions[0].keywords[0];
                document.getElementById('province-select').value = suggestion.province;
                updateSearchEnhancement();
                suggestionsDiv.classList.add('hidden');
            };

            suggestionsDiv.appendChild(suggestionItem);
        });

        suggestionsDiv.classList.remove('hidden');
    }

    // Update search enhancement info
    async function updateSearchEnhancement() {
        const query = document.getElementById('search-query').value.trim();
        const province = document.getElementById('province-select').value;
        const enhancementInfo = document.getElementById('search-enhancement-info');

        if (!query || !province) {
            enhancementInfo.classList.add('hidden');
            return;
        }

        try {
            const response = await fetch('/api/thai-provinces/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: query,
                    province: province
                })
            });

            const result = await response.json();

            if (result.success && result.valid && result.enhanced_query) {
                document.getElementById('enhanced-province-name').textContent = result.province_data.name;
                document.getElementById('enhanced-query-example').textContent = result.enhanced_query;
                enhancementInfo.classList.remove('hidden');
            } else {
                enhancementInfo.classList.add('hidden');
            }
        } catch (error) {
            console.error('Failed to validate search:', error);
            enhancementInfo.classList.add('hidden');
        }
    }

    // Clear search function
    function clearSearch() {
        document.getElementById('search-query').value = '';
        document.getElementById('province-select').value = '';
        document.getElementById('max-results').value = '10';
        document.getElementById('language-region').value = 'th';
        document.getElementById('search-enhancement-info').classList.add('hidden');
        document.getElementById('query-suggestions').classList.add('hidden');
    }

    // Initialize provinces
    async function initializeProvinces() {
        try {
            const response = await fetch('/api/thai-provinces');
            const result = await response.json();

            if (result.success && result.provinces) {
                const provinceSelect = document.getElementById('province-select');
                provinceSelect.innerHTML = '<option value="">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</option>';

                Object.entries(result.provinces).forEach(([province, data]) => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    provinceSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Failed to load provinces:', error);
        }
    }

    // Initialize popular searches
    async function initializePopularSearches() {
        try {
            const response = await fetch('/api/thai-provinces/popular-searches');
            const result = await response.json();

            if (result.success && result.searches) {
                window.popularSearches = result.searches;
                displayPopularSearches();
            }
        } catch (error) {
            console.error('Failed to load popular searches:', error);
        }
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', async function() {
        // Initialize provinces
        await initializeProvinces();

        // Initialize popular searches
        await initializePopularSearches();

        // Setup event listeners
        setupEventListeners();

        // Load initial settings
        await loadAllSettings();
    });
</script>
{% endblock %}
