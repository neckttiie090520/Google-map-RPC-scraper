{% extends "base.html" %}

{% block title %}งานปัจจุบัน - Google Maps Scraper{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center space-x-2">
            <span class="material-icons text-google-blue text-4xl">task</span>
            <span>งานปัจจุบัน</span>
        </h1>
        <p class="text-gray-600">ติดตามความคืบหน้าของงานที่กำลังดำเนินการ</p>
    </div>

    <!-- Tasks List -->
    <div id="tasks-container" class="space-y-4">
        <!-- Tasks will be inserted here -->
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
        <span class="material-icons text-gray-400 mb-4" style="font-size: 64px;">task_alt</span>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">ไม่มีงานที่กำลังดำเนินการ</h3>
        <p class="text-gray-600 mb-4">เริ่มค้นหาและดึงข้อมูลสถานที่เพื่อดูงานที่นี่</p>
        <a href="/search" class="inline-flex items-center space-x-2 bg-google-blue hover:bg-blue-600 text-white font-medium px-6 py-2 rounded-lg">
            <span class="material-icons">search</span>
            <span>เริ่มค้นหา</span>
        </a>
    </div>
</div>

<!-- Task Detail Modal -->
<div id="task-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] flex flex-col">
        <!-- Modal Header -->
        <div class="p-6 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
            <div>
                <h2 class="text-xl font-semibold text-gray-900" id="detail-task-name">Task Detail</h2>
                <p class="text-sm text-gray-600" id="detail-task-id"></p>
            </div>
            <button onclick="closeTaskDetail()" class="text-gray-500 hover:text-gray-700">
                <span class="material-icons">close</span>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Progress Section -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center space-x-2">
                    <span class="material-icons text-google-blue">insights</span>
                    <span>ความคืบหน้า</span>
                </h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-600 font-medium mb-1">สถานที่</p>
                        <p class="text-2xl font-bold text-blue-700">
                            <span id="detail-completed-places">0</span>/<span id="detail-total-places">0</span>
                        </p>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-sm text-green-600 font-medium mb-1">รีวิว</p>
                        <p class="text-2xl font-bold text-green-700" id="detail-total-reviews">0</p>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <p class="text-sm text-purple-600 font-medium mb-1">สถานะ</p>
                        <p class="text-2xl font-bold text-purple-700" id="detail-status">-</p>
                    </div>
                </div>
            </div>

            <!-- Current Place -->
            <div id="detail-current-place-section" class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm text-yellow-700 font-medium mb-1">กำลังดำเนินการ:</p>
                <p class="text-lg font-semibold text-yellow-900" id="detail-current-place">-</p>
            </div>

            <!-- Logs Section -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center space-x-2">
                    <span class="material-icons text-google-blue">description</span>
                    <span>Log การทำงาน</span>
                </h3>
                <div id="detail-logs" class="bg-gray-900 text-gray-100 rounded-lg p-4 font-mono text-sm max-h-96 overflow-y-auto">
                    <!-- Logs will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0">
            <button
                onclick="closeTaskDetail()"
                class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
            >
                ปิด
            </button>
            <button
                id="view-results-btn"
                onclick="viewResults()"
                class="hidden px-6 py-2 bg-google-blue hover:bg-blue-600 text-white rounded-lg flex items-center space-x-2"
            >
                <span class="material-icons">visibility</span>
                <span>ดูผลลัพธ์</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let activeTasks = [];
    let currentDetailTaskId = null;
    let sseConnections = {};

    // Load tasks
    async function loadTasks() {
        try {
            const response = await fetch('/api/tasks');
            const data = await response.json();

            if (data.success) {
                activeTasks = data.tasks;
                displayTasks(data.tasks);

                // Setup SSE for each task
                data.tasks.forEach(task => {
                    if (task.status === 'running' && !sseConnections[task.task_id]) {
                        setupSSE(task.task_id);
                    }
                });
            }
        } catch (error) {
            console.error('Failed to load tasks:', error);
        }
    }

    // Display tasks
    function displayTasks(tasks) {
        const container = document.getElementById('tasks-container');
        const emptyState = document.getElementById('empty-state');

        if (tasks.length === 0) {
            container.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }

        emptyState.classList.add('hidden');
        container.innerHTML = '';

        tasks.forEach(task => {
            const card = createTaskCard(task);
            container.appendChild(card);
        });
    }

    // Create task card
    function createTaskCard(task) {
        const div = document.createElement('div');
        div.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-6';
        div.id = `task-${task.task_id}`;

        const statusColors = {
            'pending': 'bg-gray-100 text-gray-700',
            'running': 'bg-blue-100 text-blue-700',
            'completed': 'bg-green-100 text-green-700',
            'failed': 'bg-red-100 text-red-700'
        };

        const statusIcons = {
            'pending': 'schedule',
            'running': 'sync',
            'completed': 'check_circle',
            'failed': 'error'
        };

        const statusText = {
            'pending': 'รอดำเนินการ',
            'running': 'กำลังทำงาน',
            'completed': 'สำเร็จ',
            'failed': 'ล้มเหลว'
        };

        // Calculate progress based on reviews scraped vs max_reviews setting
        const totalReviews = task.total_reviews || 0;
        const maxReviews = task.max_reviews || 10000;
        const progress = Math.min(100, (totalReviews / maxReviews) * 100);

        div.innerHTML = `
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColors[task.status]} flex items-center space-x-1">
                            <span class="material-icons text-sm ${task.status === 'running' ? 'animate-spin' : ''}">${statusIcons[task.status]}</span>
                            <span>${statusText[task.status]}</span>
                        </span>
                        <span class="text-xs text-gray-500">${task.task_id}</span>
                    </div>
                    ${task.current_place ? `
                        <p class="text-sm text-gray-600 mb-1">
                            <span class="font-medium">กำลังดำเนินการ:</span> ${task.current_place}
                        </p>
                    ` : ''}
                </div>
                <button
                    onclick="showTaskDetail('${task.task_id}')"
                    class="px-4 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-1"
                >
                    <span class="material-icons text-sm">visibility</span>
                    <span>ดูรายละเอียด</span>
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-600">ความคืบหน้า</span>
                    <span class="font-medium text-gray-900">
                        ${(task.total_reviews || 0).toLocaleString()} / ${task.is_unlimited ? (task.max_reviews || 0).toLocaleString() : (task.max_reviews || 0).toLocaleString()} รีวิว
                        ${task.is_unlimited ? '<span class="text-xs text-blue-600 ml-1">(ไม่จำกัด)</span>' : ''}
                    </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-google-blue h-2 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>สถานที่: ${task.completed_places || 0}/${task.total_places || 0}</span>
                    <span>${task.status === 'running' ? 'กำลังดึงข้อมูล...' : task.status === 'completed' ? 'ดึงข้อมูลสำเร็จ' : ''}</span>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-3 gap-4">
                <div class="text-center">
                    <p class="text-2xl font-bold text-gray-900">${task.total_places || 0}</p>
                    <p class="text-xs text-gray-600">สถานที่ทั้งหมด</p>
                </div>
                <div class="text-center">
                    <p class="text-2xl font-bold text-google-blue">${(task.total_reviews || 0).toLocaleString()}</p>
                    <p class="text-xs text-gray-600">รีวิวที่ดึง</p>
                </div>
                <div class="text-center">
                    <p class="text-2xl font-bold text-green-600">${task.completed_places || 0}</p>
                    <p class="text-xs text-gray-600">สำเร็จแล้ว</p>
                </div>
            </div>

            ${task.status === 'completed' ? `
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <a
                        href="/results/${task.task_id}"
                        class="w-full flex justify-center items-center space-x-2 bg-google-blue hover:bg-blue-600 text-white font-medium px-4 py-2 rounded-lg"
                    >
                        <span class="material-icons">visibility</span>
                        <span>ดูผลลัพธ์</span>
                    </a>
                </div>
            ` : ''}
        `;

        return div;
    }

    // Setup SSE for real-time updates
    function setupSSE(taskId) {
        if (sseConnections[taskId]) return;

        const eventSource = new EventSource(`/api/tasks/${taskId}/stream`);

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            // Update task in list
            const taskIndex = activeTasks.findIndex(t => t.task_id === taskId);
            if (taskIndex !== -1) {
                activeTasks[taskIndex] = data.task;

                // Update card
                const card = document.getElementById(`task-${taskId}`);
                if (card) {
                    const newCard = createTaskCard(data.task);
                    card.replaceWith(newCard);
                }
            }

            // Update detail modal if open
            if (currentDetailTaskId === taskId) {
                updateTaskDetail(data.task, data.logs);
            }

            // Close SSE if task completed
            if (data.task.status === 'completed' || data.task.status === 'failed') {
                eventSource.close();
                delete sseConnections[taskId];
            }
        };

        eventSource.onerror = function(error) {
            console.error('SSE error:', error);
            eventSource.close();
            delete sseConnections[taskId];
        };

        sseConnections[taskId] = eventSource;
    }

    // Show task detail modal
    async function showTaskDetail(taskId) {
        currentDetailTaskId = taskId;

        const modal = document.getElementById('task-detail-modal');
        modal.classList.remove('hidden');

        // Load task details
        try {
            const response = await fetch(`/api/tasks/${taskId}/status`);
            const data = await response.json();

            if (data.success) {
                updateTaskDetail(data.task, data.logs);

                // Setup SSE for updates if running
                if (data.task.status === 'running') {
                    setupSSE(taskId);
                }

                // Show results button if completed
                if (data.task.status === 'completed') {
                    document.getElementById('view-results-btn').classList.remove('hidden');
                }
            }
        } catch (error) {
            console.error('Failed to load task details:', error);
            showAlert('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
        }
    }

    // Update task detail
    function updateTaskDetail(task, logs) {
        document.getElementById('detail-task-name').textContent = `Task: ${task.task_id}`;
        document.getElementById('detail-task-id').textContent = `สร้างเมื่อ: ${new Date(task.created_at).toLocaleString('th-TH')}`;

        document.getElementById('detail-completed-places').textContent = task.completed_places || 0;
        document.getElementById('detail-total-places').textContent = task.total_places || 0;

        // Show reviews with max_reviews and unlimited indicator
        const totalReviews = (task.total_reviews || 0).toLocaleString();
        const maxReviews = (task.max_reviews || 0).toLocaleString();
        const unlimitedText = task.is_unlimited ? ' (ไม่จำกัด)' : '';
        document.getElementById('detail-total-reviews').textContent = `${totalReviews} / ${maxReviews}${unlimitedText}`;

        document.getElementById('detail-status').textContent = getStatusText(task.status);

        // Current place
        const currentPlaceSection = document.getElementById('detail-current-place-section');
        if (task.current_place && task.status === 'running') {
            currentPlaceSection.classList.remove('hidden');
            document.getElementById('detail-current-place').textContent = task.current_place;
        } else {
            currentPlaceSection.classList.add('hidden');
        }

        // Update logs
        const logsContainer = document.getElementById('detail-logs');
        if (logs && logs.length > 0) {
            logsContainer.innerHTML = logs.map(log => {
                const levelColors = {
                    'info': 'text-blue-400',
                    'success': 'text-green-400',
                    'warning': 'text-yellow-400',
                    'error': 'text-red-400'
                };

                const time = new Date(log.timestamp).toLocaleTimeString('th-TH');

                return `<div class="mb-1"><span class="text-gray-500">[${time}]</span> <span class="${levelColors[log.level] || 'text-gray-400'}">[${log.level.toUpperCase()}]</span> ${log.message}</div>`;
            }).join('');

            // Auto scroll to bottom
            logsContainer.scrollTop = logsContainer.scrollHeight;
        } else {
            logsContainer.innerHTML = '<div class="text-gray-500">ไม่มี log</div>';
        }
    }

    // Close task detail
    function closeTaskDetail() {
        document.getElementById('task-detail-modal').classList.add('hidden');
        document.getElementById('view-results-btn').classList.add('hidden');
        currentDetailTaskId = null;
    }

    // View results
    function viewResults() {
        if (currentDetailTaskId) {
            window.location.href = `/results/${currentDetailTaskId}`;
        }
    }

    // Get status text
    function getStatusText(status) {
        const texts = {
            'pending': 'รอดำเนินการ',
            'running': 'กำลังทำงาน',
            'completed': 'สำเร็จ',
            'failed': 'ล้มเหลว'
        };
        return texts[status] || status;
    }

    // Load tasks on page load
    loadTasks();

    // Refresh tasks every 5 seconds
    setInterval(loadTasks, 5000);

    // Cleanup SSE on page unload
    window.addEventListener('beforeunload', () => {
        Object.values(sseConnections).forEach(conn => conn.close());
    });
</script>
{% endblock %}
