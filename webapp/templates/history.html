{% extends "base.html" %}

{% block title %}ประวัติรีวิว - Google Maps Scraper{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center space-x-2">
            <span class="material-icons text-google-blue text-4xl">history</span>
            <span>ประวัติรีวิวทั้งหมด</span>
        </h1>
        <p class="text-gray-600">ดูรีวิวทั้งหมดที่เคยดึงข้อมูลมาพร้อมข้อความต้นฉบับและคำแปล</p>
    </div>

    <!-- Tasks Search -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center space-x-4">
            <div class="flex-1">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-2">
                    ค้นหา Tasks
                </label>
                <div class="relative">
                    <input
                        type="text"
                        id="search-input"
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-google-blue focus:border-transparent"
                        placeholder="ค้นหาจากชื่อสถานที่, Task ID, หรือภาษา..."
                        oninput="filterTasks()"
                    >
                    <span class="material-icons absolute left-3 top-2.5 text-gray-400">search</span>
                </div>
            </div>
            <button
                onclick="exportToCSV()"
                class="bg-green-600 hover:bg-green-700 text-white font-medium px-6 py-2 rounded-lg flex items-center space-x-2 transition-colors"
            >
                <span class="material-icons">download</span>
                <span>ส่งออก CSV</span>
            </button>
        </div>
    </div>

    <!-- Tasks Cards Container -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <!-- Loading State -->
        <div id="loading-state" class="p-12 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-google-blue mx-auto mb-4"></div>
            <p class="text-gray-600">กำลังโหลดข้อมูล Tasks...</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden p-12 text-center">
            <span class="material-icons text-gray-400 mb-4" style="font-size: 64px;">history</span>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">ยังไม่มีประวัติการดึงข้อมูล</h3>
            <p class="text-gray-600 mb-4">ยังไม่เคยดึงข้อมูลรีวิวจาก Google Maps</p>
            <a href="/search" class="inline-flex items-center space-x-2 bg-google-blue hover:bg-blue-600 text-white font-medium px-6 py-2 rounded-lg">
                <span class="material-icons">search</span>
                <span>เริ่มดึงข้อมูลรีวิว</span>
            </a>
        </div>

        <!-- Tasks Cards Grid -->
        <div id="tasks-container" class="hidden">
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900">ประวัติการดึงข้อมูล</h2>
                <p class="text-gray-600 mt-1">แสดงทั้งหมด <span id="total-tasks" class="font-semibold">0</span> tasks ที่ดึงข้อมูลสำเร็จ</p>
            </div>

            <div id="tasks-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Task cards will be inserted here -->
            </div>
        </div>
    </div>
</div>

<script>
let allTasks = [];

// Language names mapping
const languageNames = {
    'th': 'ไทย', 'en': 'อังกฤษ', 'ja': 'ญี่ปุ่น',
    'zh': 'จีน', 'zh-cn': 'จีนตัวย่อ', 'zh-tw': 'จีนตัวเต็ม', 'zh-hk': 'จีนฮ่องกง',
    'ko': 'เกาหลี', 'vi': 'เวียดนาม', 'id': 'อินโดนีเซีย', 'ms': 'มาเลย์'
};

// Load reviews from all output directories
async function loadReviews() {
    console.log('DEBUG: Starting loadReviews...');
    try {
        showLoading(true);
        console.log('DEBUG: Loading state shown');

        console.log('DEBUG: Fetching /api/history...');
        const response = await fetch('/api/history');
        console.log('DEBUG: Response received:', response.status);

        const data = await response.json();
        console.log('DEBUG: Data parsed:', { success: data.success, taskCount: data.history?.length });

        if (data.success) {
            allTasks = data.history || [];
            document.getElementById('total-tasks').textContent = allTasks.length;

            console.log('DEBUG: Tasks loaded:', allTasks.length);

            if (allTasks.length > 0) {
                displayTasks();
                showEmptyState(false);
                console.log('DEBUG: Tasks displayed successfully');
            } else {
                showEmptyState(true);
                console.log('DEBUG: No tasks found, showing empty state');
            }
        } else {
            console.error('Failed to load tasks:', data.error);
            showEmptyState(true);
        }
    } catch (error) {
        console.error('Error loading tasks:', error);
        showEmptyState(true);
    } finally {
        console.log('DEBUG: Hiding loading state');
        showLoading(false);

        // Additional cleanup in finally block
        console.log('DEBUG: Performing final cleanup in loadReviews...');

        // Remove any remaining loading-overlay elements
        const loadingOverlays = document.querySelectorAll('#loading-overlay');
        loadingOverlays.forEach(overlay => {
            console.log('DEBUG: Finally: Removing loading overlay:', overlay);
            overlay.remove();
        });

        // Hide global loading overlay from base template
        if (typeof hideLoading === 'function') {
            console.log('DEBUG: Finally: Calling global hideLoading() function');
            hideLoading();
        }
    }
}

// Display tasks as cards
function displayTasks() {
    console.log('DEBUG: displayTasks called with', allTasks.length, 'tasks');
    const tasksGrid = document.getElementById('tasks-grid');

    if (allTasks.length === 0) {
        console.log('DEBUG: No tasks to display, showing empty state');
        showEmptyState(true);
        return;
    }

    console.log('DEBUG: Creating task cards...');
    const taskCards = allTasks.map(task => createTaskCard(task)).join('');
    console.log('DEBUG: Task cards created, setting innerHTML');

    tasksGrid.innerHTML = taskCards;

    // Show tasks container and hide empty state
    console.log('DEBUG: Showing tasks container, hiding loading and empty states');

    const tasksContainer = document.getElementById('tasks-container');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');

    console.log('DEBUG: Elements found:', {
        tasksContainer: !!tasksContainer,
        loadingState: !!loadingState,
        emptyState: !!emptyState
    });

    console.log('DEBUG: Current classes before change:', {
        tasksContainer: tasksContainer ? tasksContainer.className : 'NOT FOUND',
        loadingState: loadingState ? loadingState.className : 'NOT FOUND',
        emptyState: emptyState ? emptyState.className : 'NOT FOUND'
    });

    tasksContainer.classList.remove('hidden');
    emptyState.classList.add('hidden');
    loadingState.classList.add('hidden');

    // Force hide with inline styles as fallback
    loadingState.style.display = 'none';
    emptyState.style.display = 'none';
    tasksContainer.style.display = 'block';

    // Hide global loading overlay from base template
    if (typeof hideLoading === 'function') {
        console.log('DEBUG: Calling global hideLoading() function');
        hideLoading();
        console.log('DEBUG: Global hideLoading() called');
    } else {
        console.log('DEBUG: Global hideLoading function not available');
    }

    // Additional cleanup: Remove any remaining loading overlays
    console.log('DEBUG: Performing additional loading cleanup...');

    // Remove any remaining loading-overlay elements
    const loadingOverlays = document.querySelectorAll('#loading-overlay');
    loadingOverlays.forEach(overlay => {
        console.log('DEBUG: Removing loading overlay:', overlay);
        overlay.remove();
    });

    // Remove any elements with loading classes that might be stuck
    const loadingElements = document.querySelectorAll('[class*="loading"], [class*="animate-spin"]');
    loadingElements.forEach(element => {
        console.log('DEBUG: Found loading element:', element);
        // Check if this element has text "false" or is a spinner
        if (element.textContent.includes('false') || element.classList.contains('animate-spin')) {
            console.log('DEBUG: Removing problematic loading element:', element);
            element.remove();
        }
    });

    console.log('DEBUG: Loading cleanup completed');

    console.log('DEBUG: Current classes after change:', {
        tasksContainer: tasksContainer ? tasksContainer.className : 'NOT FOUND',
        loadingState: loadingState ? loadingState.className : 'NOT FOUND',
        emptyState: emptyState ? emptyState.className : 'NOT FOUND'
    });

    console.log('DEBUG: Tasks display completed');
}

// Create task card HTML
function createTaskCard(task) {
    const taskDate = new Date(task.created_at).toLocaleDateString('th-TH', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    const statusColor = task.status === 'completed' ? 'green' :
                       task.status === 'failed' ? 'red' :
                       task.status === 'running' ? 'blue' : 'gray';

    const statusText = task.status === 'completed' ? 'สำเร็จ' :
                      task.status === 'failed' ? 'ล้มเหลว' :
                      task.status === 'running' ? 'กำลังทำงาน' : 'อยู่ในคิว';

    return `
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer"
             onclick="goToTaskResults('${task.task_id}')">
            <div class="p-6">
                <!-- Header -->
                <div class="flex items-center justify-between mb-4">
                    <span class="material-icons text-${statusColor}-600" style="font-size: 24px;">
                        ${task.status === 'completed' ? 'check_circle' :
                          task.status === 'failed' ? 'error' :
                          task.status === 'running' ? 'hourglass_empty' : 'schedule'}
                    </span>
                    <span class="px-2 py-1 text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800 rounded-full">
                        ${statusText}
                    </span>
                </div>

                <!-- Task ID and Date -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-1 truncate" title="${task.task_id}">
                        ${task.task_id.substring(0, 8)}...
                    </h3>
                    <p class="text-sm text-gray-600">${taskDate}</p>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-50 rounded-lg p-3">
                        <div class="flex items-center">
                            <span class="material-icons text-blue-600 mr-2" style="font-size: 16px;">rate_review</span>
                            <div>
                                <p class="text-xs text-blue-600 font-medium">รีวิว</p>
                                <p class="text-sm font-semibold text-blue-700">${task.total_reviews || 0}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-3">
                        <div class="flex items-center">
                            <span class="material-icons text-green-600 mr-2" style="font-size: 16px;">place</span>
                            <div>
                                <p class="text-xs text-green-600 font-medium">สถานที่</p>
                                <p class="text-sm font-semibold text-green-700">${task.total_places || 0}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Place Info -->
                ${task.place_name ? `
                    <div class="mb-4">
                        <p class="text-sm font-medium text-gray-700 truncate" title="${task.place_name}">
                            <span class="material-icons text-gray-400 mr-1" style="font-size: 14px;">store</span>
                            ${task.place_name}
                        </p>
                    </div>
                ` : ''}

                <!-- Language/Settings Info -->
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <span class="flex items-center">
                        <span class="material-icons mr-1" style="font-size: 14px;">language</span>
                        ${task.language ? languageNames[task.language] || task.language.toUpperCase() : 'N/A'}
                    </span>
                    ${task.date_range ? `
                        <span class="flex items-center">
                            <span class="material-icons mr-1" style="font-size: 14px;">date_range</span>
                            ${task.date_range}
                        </span>
                    ` : ''}
                </div>

                <!-- View Results Button -->
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <button class="w-full bg-google-blue hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-colors flex items-center justify-center space-x-2">
                        <span class="material-icons" style="font-size: 16px;">visibility</span>
                        <span>ดูผลลัพธ์</span>
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Navigate to task results page
function goToTaskResults(taskId) {
    window.location.href = `/results/${taskId}`;
}

// Generate star rating display
function generateStars(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            stars += '<span class="material-icons text-yellow-400 text-sm">star</span>';
        } else {
            stars += '<span class="material-icons text-gray-300 text-sm">star_border</span>';
        }
    }
    return stars;
}

// Show review detail modal
function showReviewDetail(index) {
    const review = allReviews[index];

    // Populate modal data
    document.getElementById('modal-title').textContent = 'รายละเอียดรีวิว';
    document.getElementById('modal-author').textContent = review.author_name || '-';
    document.getElementById('modal-rating').textContent = `${review.rating || 0}/5`;
    document.getElementById('modal-date').textContent = review.date_formatted || review.date_relative || '-';
    document.getElementById('modal-original-lang').textContent = review.review_text_language ? languageNames[review.review_text_language] : '-';
    document.getElementById('modal-target-lang').textContent = languageNames['th'];
    document.getElementById('modal-place-id').textContent = review.place_id || '-';
    document.getElementById('modal-likes').textContent = review.review_likes || 0;
    document.getElementById('modal-photos').textContent = review.review_photos_count || 0;
    document.getElementById('modal-author-reviews').textContent = review.author_reviews_count || 0;

    // Original text
    document.getElementById('modal-original-text').textContent = review.review_text || '-';

    // Translated text
    const translatedText = review.review_text_translated;
    document.getElementById('modal-translated-text').textContent = translatedText || '-';

    // Owner response
    if (review.owner_response) {
        document.getElementById('modal-owner-response').classList.remove('hidden');
        document.getElementById('modal-owner-text').textContent = review.owner_response;
    } else {
        document.getElementById('modal-owner-response').classList.add('hidden');
    }

    if (review.owner_response_translated) {
        document.getElementById('modal-translated-owner').classList.remove('hidden');
        document.getElementById('modal-translated-owner-text').textContent = review.owner_response_translated;
    } else {
        document.getElementById('modal-translated-owner').classList.add('hidden');
    }

    // Show modal
    document.getElementById('review-modal').classList.remove('hidden');
}

// Close review modal
function closeReviewModal() {
    document.getElementById('review-modal').classList.add('hidden');
}

// Filter tasks based on search input
function filterTasks() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const tasksGrid = document.getElementById('tasks-grid');

    if (!searchTerm) {
        // Show all tasks if no search term
        tasksGrid.innerHTML = allTasks.map(task => createTaskCard(task)).join('');
        return;
    }

    // Filter tasks based on search term
    const filteredTasks = allTasks.filter(task => {
        return (
            (task.task_id && task.task_id.toLowerCase().includes(searchTerm)) ||
            (task.place_name && task.place_name.toLowerCase().includes(searchTerm)) ||
            (task.language && task.language.toLowerCase().includes(searchTerm)) ||
            (task.status && task.status.toLowerCase().includes(searchTerm))
        );
    });

    if (filteredTasks.length === 0) {
        tasksGrid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <span class="material-icons text-gray-400 mb-4" style="font-size: 64px;">search_off</span>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">ไม่พบ Task ที่ค้นหา</h3>
                <p class="text-gray-600">ลองปรับเปลี่ยนคำค้นหาและลองอีกครั้ง</p>
            </div>
        `;
    } else {
        tasksGrid.innerHTML = filteredTasks.map(task => createTaskCard(task)).join('');
    }
}

// Export to CSV
async function exportToCSV() {
    if (allTasks.length === 0) {
        alert('ไม่มีข้อมูล Tasks ที่จะส่งออก');
        return;
    }

    try {
        const response = await fetch('/api/history/export-csv', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                tasks: allTasks
            })
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tasks_history_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            alert('เกิดข้อผิดพลาดในการส่งออก CSV');
        }
    } catch (error) {
        console.error('Error exporting CSV:', error);
        alert('เกิดข้อผิดพลาดในการส่งออก CSV');
    }
}


// Show/hide loading state
function showLoading(show) {
    document.getElementById('loading-state').classList.toggle('hidden', !show);
    document.getElementById('tasks-container').classList.toggle('hidden', show);
    document.getElementById('empty-state').classList.add('hidden');
}

// Show/hide empty state
function showEmptyState(show) {
    document.getElementById('empty-state').classList.toggle('hidden', !show);
    document.getElementById('tasks-container').classList.toggle('hidden', show);
    document.getElementById('loading-state').classList.add('hidden');
}


// Load tasks on page load
document.addEventListener('DOMContentLoaded', loadReviews);
</script>
{% endblock %}